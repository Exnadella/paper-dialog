<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>

<head>

  <title>paper-dialog tests</title>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../paper-dialog.html">
</head>

<body>

  <test-fixture id="basic">
    <template>
      <paper-dialog>
        <p>Dialog</p>
      </paper-dialog>
    </template>
  </test-fixture>

  <test-fixture id="modal">
    <template>
      <paper-dialog modal>
        <p>Dialog</p>
      </paper-dialog>
    </template>
  </test-fixture>

  <test-fixture id="opened-modals">
    <template>
      <paper-dialog modal opened>
        <p>Dialog 1</p>
        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit.</p>
      </paper-dialog>
      <paper-dialog modal opened>
        <p>Dialog 2</p>
      </paper-dialog>
    </template>
  </test-fixture>

  <test-fixture id="animations">
    <template>
      <paper-dialog entry-animation="fade-in-animation" exit-animation="fade-out-animation">
        <p>Dialog</p>
        <paper-dialog entry-animation="fade-in-animation">
          <p>Dialog</p>
        </paper-dialog>
      </paper-dialog>
    </template>
  </test-fixture>

  <script>
    suite('modal', function() {

      test('backdrop element remains opened when closing top modal, closes when all modals are closed', function(
        done) {
        var modals = fixture('opened-modals');
        modals[1].addEventListener('iron-overlay-opened', function() {
          assert.isTrue(modals[1].backdropElement.opened, 'backdrop is open');
          modals[1].close();
        });
        modals[1].addEventListener('iron-overlay-closed', function() {
          assert.isTrue(modals[1].backdropElement.opened, 'backdrop is still open');
          modals[0].close();
        });
        modals[0].addEventListener('iron-overlay-closed', function() {
          assert.isFalse(modals[0].backdropElement.opened, 'backdrop is closed');
          done();
        });
      });

    });

    suite('animations', function() {

      var dialog, innerDialog;
      var animationDuration = 50;
      // We wait some extra ms so that `animationend` can propagate up and
      // be captured by the test spies.
      var timeoutMs = animationDuration + 50;
      setup(function() {
        dialog = fixture('animations');
        innerDialog = dialog.querySelector('paper-dialog');
        // Make it quick.
        dialog.style.animationDuration =
          innerDialog.style.animationDuration = animationDuration + 'ms';
      });

      test('should not animate by default', function(done) {
        var dialog = fixture('basic');
        var spy = sinon.stub();
        dialog.addEventListener('animationend', spy);
        dialog.open();
        setTimeout(function() {
          assert.isTrue(dialog.opened, 'opened ok');
          assert.equal(spy.callCount, 0, 'no open animation');
          dialog.close();
          setTimeout(function() {
            assert.isFalse(dialog.opened, 'closed ok');
            assert.equal(spy.callCount, 0, 'no close animation');
            done();
          }, timeoutMs);
        }, timeoutMs);
      });

      test('should animate on opened and closed', function(done) {
        var spy = sinon.stub();
        dialog.addEventListener('animationend', spy);
        dialog.open();
        setTimeout(function() {
          assert.isTrue(dialog.opened, 'opened ok');
          assert.equal(spy.callCount, 1, 'open animation ok');
          dialog.close();
          setTimeout(function() {
            assert.isFalse(dialog.opened, 'closed ok');
            assert.equal(spy.callCount, 2, 'close animation ok');
            done();
          }, timeoutMs);
        }, timeoutMs);
      });
      
      test('should recognize undefined animations', function(done) {
        dialog.entryAnimation = 'undefined-animation'
        var spy = sinon.stub();
        dialog.addEventListener('animationend', spy);
        dialog.open();
        setTimeout(function() {
          assert.isTrue(dialog.opened, 'opened ok');
          assert.equal(spy.callCount, 0, 'open animation ok');
          done();
        }, timeoutMs);
      });

      test('should remove animation classes when done animating', function(done) {
        dialog.open();
        dialog.addEventListener('iron-overlay-opened', function() {
          assert.isFalse(dialog.classList.contains(dialog.entryAnimation), 'no entry animation class');
          dialog.close();
        });
        dialog.addEventListener('iron-overlay-closed', function() {
          assert.isFalse(dialog.classList.contains(dialog.exitAnimation), 'no exit animation class');
          done();
        });
      });

      test('should handle only its own animations', function(done) {

        var callCount = 0;
        dialog.addEventListener('iron-overlay-opened', function(event) {
          // `iron-overlay-opened` is composed and bubbles, so increase the count only
          // if it got triggered by `dialog`.
          if (event.target === dialog) {
            callCount++;
          }
        });
        dialog.open();
        innerDialog.open();
        setTimeout(function() {
          assert.isTrue(dialog.opened, 'dialog opened');
          assert.isTrue(innerDialog.opened, 'innerDialog opened');
          assert.equal(callCount, 1, 'opened event fired once');
          done();
        }, timeoutMs);
      });

    });

    suite('a11y', function() {
      a11ySuite('basic', []);

      a11ySuite('modal', []);

      test('dialog has role="dialog"', function() {
        var dialog = fixture('basic');
        assert.equal(dialog.getAttribute('role'), 'dialog', 'has role="dialog"');
      });

    });
  </script>

</body>

</html>